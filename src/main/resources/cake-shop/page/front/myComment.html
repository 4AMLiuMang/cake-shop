<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奈川蛋糕店</title>
    <link rel="shortcut icon" href="../../favicon.png">
    <!-- 引入el样式 -->
    <link rel="stylesheet" href="../../plugins/element-ui/index.css">
    <link rel="stylesheet" href="../../styles/reset.css" />
    <link rel="stylesheet" href="../../styles/front/myComment.css" />
</head>

<body>
    <!-- 主体 -->
    <div class="app" id="app">
        <div class="Comment">
            <div class="Comment-info" v-for="(cmt, index) in CommentInfo" :key="cmt.id">
                <div class="Comment-info-userAvatar">
                    <el-avatar style="width: 50px; height: 50px" shape="square" size="large" :src="cmt.userAvatar"
                        fit="fill"></el-avatar>
                </div>
                <div class="Comment-info-userNickname">{{cmt.cakeName}}</div>
                <div class="Comment-info-createTime">{{cmt.createTime}}</div>
                <div class="Comment-info-cmtContent">{{cmt.cmtContent}}</div>
                <div class="Comment-button2">
                    <el-button class="Comment-button" type="danger" plain @click="handleDltCmt(cmt.id)">删除评论
                    </el-button>
                </div>
                <div class="Comment-button1">
                    <el-button class="Comment-button" type="primary" plain @click="handleShowCake(cmt.cakeId)">查看蛋糕
                    </el-button>
                </div>
            </div>
        </div>
        <!--蛋糕详情弹窗-->
        <div>
            <el-dialog title="详细信息" :visible.sync="cardDV" width="50%" :before-close="handleClose">
                <div class="cardDV">
                    <div class="cardDV-cakeImg">
                        <el-image v-if="cardDVInfo.cakeStatus" style="width: 320px; height: 320px"
                            :src="cardDVInfo.cakeImg" fit="fill"></el-image>
                        </el-image>
                        <el-image v-else style="width: 320px; height: 320px" src="../../images/nothing.png" fit="fill">
                        </el-image>
                    </div>
                    <div class="cardDV-cakeName">{{cardDVInfo.cakeName}}</div>
                    <div class="cardDV-cakeType">蛋糕分类:<br />{{cardDVInfo.cakeType}}</div>
                    <div class="cardDV-updateTime">上架时间:<br />{{cardDVInfo.updateTime}}</div>
                    <div class="cardDV-cakeIntro">蛋糕介绍:<br />&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp{{cardDVInfo.cakeIntro}}
                    </div>
                    <div class="cardDV-cakePrice">售价:{{cardDVInfo.cakePrice}}￥</div>
                    <div class="cardDV-cakeTotal">销量:{{cardDVInfo.cakeTotal}}</div>
                    <div class="cardDV-cakeRating">
                        <el-rate v-model="cardDVInfo.cakeRating" disabled show-score text-color="#ff9900"
                            score-template="{value}评分">
                        </el-rate>
                    </div>
                    <div class="cardDV-showComment">
                        <el-button type="info" plain size="small" @click="handleShowComment">查看评论</el-button>
                    </div>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="cardDV = false">返 回</el-button>
                    <el-button type="primary" @click="cardDV = false;handlePurchase(cardDVInfo)">购 买</el-button>
                </span>
            </el-dialog>
        </div>
        <!--购买弹窗-->
        <div>
            <el-dialog title="请确认您的购买信息" :visible.sync="buyDV" width="45%" :before-close="handleClose">
                <div class="buyDV">
                    <div class="buyDV-cakeImg">
                        <el-image v-if="buyDVInfo.cakeStatus" style="width: 150px; height: 150px"
                            :src="buyDVInfo.cakeImg" fit="fill"></el-image>
                        </el-image>
                        <el-image v-else style="width: 150px; height: 150px" src="../../images/nothing.png" fit="fill">
                        </el-image>
                    </div>
                    <div class="buyDV-cakeName">{{buyDVInfo.cakeName}}</div>
                    <div class="buyDV-cakePrice">售价:{{buyDVInfo.cakePrice}}￥</div>
                    <div class="buyDV-userNickname">收件人信息:&nbsp;&nbsp;&nbsp;&nbsp;姓名:{{userData.userNickname}}</div>
                    <div class="buyDV-userPhone">电话:{{userData.userPhone}}</div>
                    <div class="buyDV-userAddress">地址:{{userData.userAddress}}</div>
                    <div>
                        <div class="buyDV-CollectionCode">此处付款</div>
                        <div class="buyDV-CollectionCode-img">
                            <el-popover placement="top" width="200" trigger="hover">
                                <div class="buyDV-QRC">
                                    <div class="buyDV-QRC-img1">
                                        <el-image style="width: 100px; height: 100px" src="../../images/QRCode1.png"
                                            fit="fill">
                                        </el-image>
                                    </div>
                                    <div class="buyDV-QRC-img2">
                                        <el-image style="width: 100px; height: 100px" src="../../images/QRCode2.png"
                                            fit="fill">
                                        </el-image>
                                    </div>
                                </div>
                                <el-image slot="reference" style="width: 50px; height: 50px"
                                    src="../../images/CollectionCode.png" fit="fill">
                                </el-image>
                            </el-popover>
                        </div>
                    </div>
                </div>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="buyDV = false">返 回</el-button>
                    <el-button type="primary" @click="handleBuyCake">我已付款</el-button>
                </span>
            </el-dialog>
        </div>
        <!--评论弹窗-->
        <div>
            <el-dialog title="全部评论" :visible.sync="CommentDV" :before-close="handleClose" fullscreen="true">
                <div class="CommentDV">
                    <div class="CommentDV-info" v-for="(cmt, index) in CommentDVInfo" :key="cmt.id">
                        <div class="CommentDV-info-userAvatar">
                            <el-avatar style="width: 50px; height: 50px" shape="square" size="large"
                                :src="cmt.userAvatar" fit="fill"></el-avatar>
                        </div>
                        <div class="CommentDV-info-userNickname">{{cmt.userNickname}}</div>
                        <div class="CommentDV-info-createTime">{{cmt.createTime}}</div>
                        <div class="CommentDV-info-cmtContent">{{cmt.cmtContent}}</div>
                    </div>
                    <div class="CommentDV-button1">
                        <el-button class="CommentDV-button" type="danger" plain
                            @click="CommentDV = false; cardDV = true">返 回</el-button>
                    </div>
                    <div class="CommentDV-button2">
                        <el-button class="CommentDV-button" type="primary" plain
                            @click="CommentDV = false;handlePurchase(cardDVInfo)">购 买</el-button>
                    </div>
                </div>
            </el-dialog>
        </div>
    </div>
    <!-- 引入vue -->
    <script src="../../plugins/vue/vue.min.js"></script>
    <!-- 引入el组件库 -->
    <script src="../../plugins/element-ui/index.js"></script>
    <!-- 引入axios -->
    <script src="../../plugins/axios/axios.min.js"></script>
    <!-- 引入输入校验 -->
    <!-- <script src="../../js/validate.js"></script> -->
    <!-- 引入拦截器 -->
    <script src="../../js/request.js"></script>
    <!-- 引入接口 -->
    <script src="../../api/index.js"></script>
    <script>
        new Vue({
            el: "#app",
            data() {
                return {
                    userInfo: {},
                    userData: {
                        "id": "",
                        "userUsername": "",
                        "userPassword": "",
                        "userNickname": "",
                        "userAvatar": "",
                        "userGender": "",
                        "userPhone": "",
                        "userEmail": "",
                        "userAddress": "",
                        "userStatus": "",
                        "createTime": "",
                        "updateTime": ""
                    },
                    page: 1,
                    pageSize: 500,
                    CommentInfo: [],
                    cardDV: false,
                    cardDVInfo: {},
                    buyDV: false,
                    buyDVInfo: {},
                    CommentDV: false,
                    CommentDVInfo: [],
                }
            },
            computed: {
            },
            created() {
                this.userInfo = JSON.parse(localStorage.getItem('userInfo'))
                if (this.userInfo != null) {
                    this.userData = this.userInfo
                }
                this.init()
            },
            mounted() {
            },
            methods: {
                //异步查询评论根据用户id
                async init() {
                    const params = {
                        id: this.userData.id,
                        page: this.page,
                        pageSize: this.pageSize,
                    }
                    await getCommentByUidApi(params).then(res => {
                        if (res.code === 1) {
                            this.CommentInfo = res.data.records || []
                            if (res.data.total === 0) {
                                this.$message.error('你暂未发布评论,3秒后返回主页')
                                setTimeout(() => {
                                    window.parent.menuHandle({
                                        id: '1',
                                        url: 'page/front/homePage.html',
                                    }, false)
                                }, 4000)
                            }
                        }
                    }).catch(err => {
                        this.$message.error('请求出错了：' + err)
                    })
                },
                //根据id查询商品信息
                async handleShowCake(id) {
                    queryCakeById(id).then(res => {
                        if (res.code === 1) {
                            this.cardDVInfo = res.data
                            this.cardDV = true
                        } else {
                            this.$message.error(res.message || '操作失败')
                        }
                    })
                },
                //点击购买传入数据，用于在弹窗中展示
                handlePurchase(cakes) {
                    if (this.userInfo == null) {
                        this.cardDV = false
                        this.$message.error("您还未登录,请先登录")
                    } else if (cakes.cakeStatus == 0) {
                        this.cardDV = false
                        this.$message.error("抱歉该商品已经售空,请重新选购")
                    } else {
                        this.buyDVInfo = cakes
                        this.cardDV = false
                        this.buyDV = true
                    }
                },
                //点击购买
                handleBuyCake() {
                    const params = {
                        ...this.buyDVInfo,
                        cakeId: this.buyDVInfo.id,
                        ...this.userData,
                        userId: this.userData.id,
                    }
                    delete params.id
                    delete params.cakeIntro
                    delete params.cakeRating
                    delete params.cakeRec
                    delete params.cakeStatus
                    delete params.cakeTotal
                    delete params.cakeType
                    delete params.userUsername
                    delete params.userGender
                    delete params.userEmail
                    delete params.userPassword
                    delete params.createTime
                    delete params.updateTime
                    delete params.userStatus
                    buyCakeApi(params).then(res => {
                        if (res.code === 1) {
                            this.$message.success(res.data)
                            window.parent.menuHandle({
                                id: '3',
                                url: 'page/front/myOrders.html',
                            }, false)
                        } else {
                            this.$message.error(res.message || '操作失败')
                        }
                    }).catch(err => {
                        this.$message.error('请求出错了：' + err)
                    })
                },
                //异步查询评论
                async handleShowComment() {
                    const params = {
                        id: this.cardDVInfo.id,
                        page: this.page,
                        pageSize: this.pageSize,
                    }
                    await getCommentByCidApi(params).then(res => {
                        if (res.code === 1) {
                            this.CommentDVInfo = res.data.records || []
                            if (res.data.total === 0) {
                                this.$message.error('该蛋糕暂无评论')
                            } else {
                                this.cardDV = false
                                this.CommentDV = true
                            }
                        }
                    }).catch(err => {
                        this.$message.error('请求出错了：' + err)
                    })
                },
                //关闭弹窗
                handleClose(done) {
                    this.$confirm('确认关闭？')
                        .then(_ => {
                            done();
                        })
                        .catch(_ => { });
                },
                //根据id删除评论
                handleDltCmt(ids) {
                    this.$confirm('此操作会永久删除评论,请确认!!!', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        deleteCmtById(ids).then(res => {
                            if (res.code === 1) {
                                this.$message.success('删除成功！')
                                // window.parent.menuHandle({
                                        // id: '0',
                                        // url: 'page/front/myComment.html',
                                    // }, false)
                                this.init()
                            } else {
                                this.$message.error(res.message || '操作失败')
                            }
                        }).catch(err => {
                            this.$message.error('请求出错了：' + err)
                        })
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '已取消删除'
                        });
                    });
                },
            }
        })
    </script>

</body>
<style>
    body {
        background-color: #bcf8f9;
        background-image: linear-gradient(90deg, #bcf8f9 0%, #fedcff 50%, #f9c9c9 100%);
    }
</style>

</html>