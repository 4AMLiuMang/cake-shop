<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奈川蛋糕店</title>
    <link rel="shortcut icon" href="favicon.png">
    <!-- 引入el样式 -->
    <link rel="stylesheet" href="../../plugins/element-ui/index.css">
    <link rel="stylesheet" href="../../styles/reset.css" />
    <link rel="stylesheet" href="../../styles/backend/commentPage.css" />
</head>

<body>
    <div class="app" id="app">
        <div>
            <!--搜索，操作-->
            <div class="table-top">
                <el-tooltip class="item" effect="dark" content="点击放大镜或敲击回车查询" placement="bottom">
                    <el-input class="head-all-input-input" placeholder="请输入蛋糕名称" clearable v-model="cakeName"
                        @keyup.enter.native="handleQuery">
                        <i slot="prefix" class="el-input__icon el-icon-search" @click="handleQuery" style="cursor: pointer;"></i>
                    </el-input>
                </el-tooltip>
                <el-tooltip class="item" effect="dark" content="点击放大镜或敲击回车查询" placement="bottom">
                    <el-input class="head-all-input-input" placeholder="请输入用户昵称" clearable v-model="userNickname"
                        @keyup.enter.native="handleQuery">
                        <i slot="prefix" class="el-input__icon el-icon-search" @click="handleQuery" style="cursor: pointer;"></i>
                    </el-input>
                </el-tooltip>
                <el-tooltip class="item" effect="dark" content="点击放大镜或敲击回车查询" placement="bottom">
                    <el-input class="head-all-input-input" placeholder="请输入评论内容" clearable v-model="cmtContent"
                        @keyup.enter.native="handleQuery">
                        <i slot="prefix" class="el-input__icon el-icon-search" @click="handleQuery" style="cursor: pointer;"></i>
                    </el-input>
                </el-tooltip>
                <el-button class="head-all-input-input head-all-input-botton" type="primary" icon="el-icon-refresh"
                    plain @click="handleQueryReset">重置</el-button>
                <div class="table-botton">
                    <el-button type="danger" plain @click="handleDelete('批量', null)">批量删除</el-button>
                </div>
            </div>
            <!--表格-->
            <el-table :data="commentData" height="540" border style="width: 100%; margin-left: 0%;"
                @selection-change="handleSelectionChange">
                <el-table-column align="center" type="selection" width="50">
                </el-table-column>
                <el-table-column type="expand">
                    <template slot-scope="props">
                        <el-form label-position="left" inline class="demo-table-expand">
                            <el-form-item label="用户评论内容:">
                                <span>{{ props.row.cmtContent }}</span>
                            </el-form-item>
                        </el-form>
                    </template>
                </el-table-column>
                <el-table-column align="center" label="蛋糕图片" width="150">
                    <template slot-scope="{ row }">
                        <el-avatar style="width: 40px; height: 40px" shape="square" size="large" :src="row.cakeImg"
                            fit="fill"></el-avatar>
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="cakeName" label="蛋糕名称" width="240">
                </el-table-column>
                <el-table-column align="center" label="用户头像" width="150">
                    <template slot-scope="{ row }">
                        <el-avatar style="width: 40px; height: 40px" shape="square" size="large" :src="row.userAvatar"
                            fit="fill"></el-avatar>
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="userNickname" label="用户昵称" width="240">
                </el-table-column>
                <el-table-column sortable align="center" prop="createTime" label="评论时间" width="280">
                </el-table-column>
                <el-table-column align="center" label="操作">
                    <template slot-scope="scope">
                        <el-button type="danger" plain @click="handleDelete('单删', scope.row.id)">删除
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>
            <!--分页条-->
            <el-pagination class="pageList" :page-sizes="[8, 16, 32, 64, 128]" :page-size="pageSize"
                layout="total, sizes, prev, pager, next, jumper" :total="counts" :current-page.sync="page"
                @size-change="handleSizeChange" @current-change="handleCurrentChange"></el-pagination>
        </div>
        <!-- 修改资料弹窗 -->
    </div>
    <!-- 引入vue -->
    <script src="../../plugins/vue/vue.min.js"></script>
    <!-- 引入el组件库 -->
    <script src="../../plugins/element-ui/index.js"></script>
    <!-- 引入axios -->
    <script src="../../plugins/axios/axios.min.js"></script>
    <!-- 引入输入校验 -->
    <script src="../../js/validate.js"></script>
    <!-- 引入拦截器 -->
    <script src="../../js/request.js"></script>
    <!-- 引入接口 -->
    <script src="../../api/backend/comment.js"></script>
    <script>
        new Vue({
            el: "#app",
            data() {
                return {
                    employeeInfo: {},
                    employeeData: {
                        "id": "",
                        "empUsername": "",
                        "empPassword": "",
                        "empNickname": "",
                        "empAvatar": "",
                        "empGender": "",
                        "empPhone": "",
                        "empIdentity": "",
                        "empEmail": "",
                        "empAddress": "",
                        "empStatus": "",
                        "createTime": "",
                        "updateTime": ""
                    },
                    page: 1,
                    pageSize: 8,
                    counts: "",
                    commentData: [],
                    cakeName: "",
                    userNickname: "",
                    cmtContent: "",
                }
            },
            computed: {},
            created() {
                this.employeeInfo = JSON.parse(window.localStorage.getItem('employeeInfo'))
                if (this.employeeInfo != null) {
                    this.employeeData = this.employeeInfo
                }
                // this.init()
                this.handleGetUserData()
            },
            mounted() {
            },
            methods: {
                //查询所有用户数据
                async handleGetUserData() {
                    const params = {
                        page: this.page,
                        pageSize: this.pageSize,
                        cakeName: this.cakeName ? this.cakeName : undefined,
                        userNickname: this.userNickname ? this.userNickname : undefined,
                        cmtContent: this.cmtContent ? this.cmtContent : undefined,
                    }
                    await getCommentList(params).then(res => {
                        if (res.code === 1) {
                            this.commentData = res.data.records || []
                            this.counts = res.data.total
                        }
                    }).catch(err => {
                        this.$message.error('请求出错了：' + err)
                    })
                },
                //模糊搜索查询
                handleQuery() {
                    this.page = 1;
                    this.handleGetUserData();
                },
                //重置分类查询
                handleQueryReset() {
                    this.cakeName = "";
                    this.userNickname = "";
                    this.cmtContent = "";
                    this.page = 1;
                    this.pageSize = 8;
                    this.handleGetUserData();
                },
                //分页查询，页数
                handleCurrentChange(val) {
                    this.page = val
                    this.handleGetUserData()
                },
                //分页查询，条数
                handleSizeChange(val) {
                    this.pageSize = val
                    this.handleGetUserData()
                },
                //将勾选的数据构成数组
                handleSelectionChange(val) {
                    let checkArr = []
                    val.forEach((n) => {
                        checkArr.push(n.id)
                    })
                    this.checkList = checkArr
                },
                // 删除
                handleDelete(type, id) {
                    if (type === '批量' && id === null) {
                        if (this.checkList.length === 0) {
                            return this.$message.error('请选择删除对象')
                        }
                    }
                    this.$confirm('确认删除该评论, 是否继续?', '确定删除', {
                        'confirmButtonText': '确定',
                        'cancelButtonText': '取消',
                        'type': 'warning'
                    }).then(() => {
                        deleteComment(type === '批量' ? this.checkList.join(',') : id).then(res => {
                            if (res.code === 1) {
                                this.$message.success('删除成功！')
                                this.handleQuery()
                            } else {
                                this.$message.error(res.message || '操作失败')
                            }
                        }).catch(err => {
                            this.$message.error('请求出错了：' + err)
                        })
                    })
                },
            }
        })
    </script>
</body>

</html>